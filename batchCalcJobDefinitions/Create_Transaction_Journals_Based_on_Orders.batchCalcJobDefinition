<?xml version="1.0" encoding="UTF-8"?>
<BatchCalcJobDefinition xmlns="http://soap.sforce.com/2006/04/metadata">
    <aggregates>
        <fields>
            <aggregateFunction>Count</aggregateFunction>
            <alias>OrderProductCount</alias>
            <sourceFieldName>OrderProductId</sourceFieldName>
        </fields>
        <groupBy>OrderId</groupBy>
        <label>12.OrdersToMarkAsPorcessed</label>
        <name>X12_OrdersToMarkAsPorcessed</name>
        <sourceName>X11_FilterActiveOrderPlusFilterActiveLoyaltyProgramMember</sourceName>
    </aggregates>
    <datasources>
        <fields>
            <alias>AccountId</alias>
            <name>AccountId</name>
        </fields>
        <fields>
            <alias>ActivatedDateTime</alias>
            <name>ActivatedDate</name>
        </fields>
        <fields>
            <alias>CopyOrderStatus</alias>
            <name>CopyOrderStatus__c</name>
        </fields>
        <fields>
            <alias>EffectiveDate</alias>
            <name>EffectiveDate</name>
        </fields>
        <fields>
            <alias>Id</alias>
            <name>Id</name>
        </fields>
        <fields>
            <alias>OrderStatus</alias>
            <name>Status</name>
        </fields>
        <label>1.Order</label>
        <name>X1_Order</name>
        <sourceName>Order</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <description>Reterive Un Processed OrderItems to create TJ</description>
        <fields>
            <alias>OrderProductId</alias>
            <name>Id</name>
        </fields>
        <fields>
            <alias>OrderId</alias>
            <name>OrderId</name>
        </fields>
        <fields>
            <alias>Product2Id</alias>
            <name>Product2Id</name>
        </fields>
        <fields>
            <alias>Quantity</alias>
            <name>Quantity</name>
        </fields>
        <fields>
            <alias>TotalPrice</alias>
            <name>TotalPrice</name>
        </fields>
        <label>2.OrderProduct</label>
        <name>X2_OrderProduct</name>
        <sourceName>OrderItem</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <fields>
            <alias>AccountId</alias>
            <name>AccountId</name>
        </fields>
        <fields>
            <alias>MemberId</alias>
            <name>Id</name>
        </fields>
        <fields>
            <alias>MemberStatus</alias>
            <name>MemberStatus</name>
        </fields>
        <fields>
            <alias>ProgramId</alias>
            <name>ProgramId</name>
        </fields>
        <label>3.LoyaltyProgramMember</label>
        <name>X3_LoyaltyProgramMember</name>
        <sourceName>LoyaltyProgramMember</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <description>Get the information from Product Category Product table</description>
        <fields>
            <alias>ProductCategoryProductId</alias>
            <name>Id</name>
        </fields>
        <fields>
            <alias>IsPrimaryCategory</alias>
            <name>IsPrimaryCategory</name>
        </fields>
        <fields>
            <alias>ProductCategoryId</alias>
            <name>ProductCategoryId</name>
        </fields>
        <fields>
            <alias>ProductId</alias>
            <name>ProductId</name>
        </fields>
        <label>4.ProductCategoryProduct</label>
        <name>X4_ProductCategoryProduct</name>
        <sourceName>ProductCategoryProduct</sourceName>
        <type>StandardObject</type>
    </datasources>
    <description>Calculates and creates transaction journal records based on the orders placed by the loyalty program members. The transaction journals are used to accrue points to the member.</description>
    <filters>
        <criteria>
            <inputVariable>startDate</inputVariable>
            <operator>GreaterThanOrEquals</operator>
            <sequence>1</sequence>
            <sourceFieldName>ActivatedDate</sourceFieldName>
        </criteria>
        <criteria>
            <inputVariable>endDate</inputVariable>
            <operator>LessThanOrEquals</operator>
            <sequence>2</sequence>
            <sourceFieldName>ActivatedDate</sourceFieldName>
        </criteria>
        <criteria>
            <operator>Equals</operator>
            <sequence>3</sequence>
            <sourceFieldName>OrderStatus</sourceFieldName>
            <value>Activated</value>
        </criteria>
        <criteria>
            <operator>NotEquals</operator>
            <sequence>4</sequence>
            <sourceFieldName>CopyOrderStatus</sourceFieldName>
            <value>Processed</value>
        </criteria>
        <filterCondition>1 AND 2 AND 3 AND 4</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>10.FilterActiveOrder</label>
        <name>X10_FilterActiveOrder</name>
        <sourceName>X9_FormulaActivatedDateJournalTypeJournalSubType</sourceName>
    </filters>
    <filters>
        <criteria>
            <inputVariable>programId</inputVariable>
            <operator>Equals</operator>
            <sequence>1</sequence>
            <sourceFieldName>ProgramId</sourceFieldName>
        </criteria>
        <criteria>
            <operator>Equals</operator>
            <sequence>2</sequence>
            <sourceFieldName>MemberStatus</sourceFieldName>
            <value>Active</value>
        </criteria>
        <description>Filter only Active Program Members</description>
        <filterCondition>1 AND 2</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>6.FilterActiveLoyaltyProgramMembers</label>
        <name>X6_FilterActiveLoyaltyProgramMembers</name>
        <sourceName>X3_LoyaltyProgramMember</sourceName>
    </filters>
    <filters>
        <criteria>
            <operator>Equals</operator>
            <sequence>1</sequence>
            <sourceFieldName>IsPrimaryCategory</sourceFieldName>
            <value>true</value>
        </criteria>
        <description>Filter only Primary category for Products</description>
        <filterCondition>1</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>7.FilterProductCategoryProduct</label>
        <name>X7_FilterProductCategoryProduct</name>
        <sourceName>X4_ProductCategoryProduct</sourceName>
    </filters>
    <isTemplate>false</isTemplate>
    <joins>
        <fields>
            <alias>AccountId</alias>
            <sourceFieldName>AccountId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>ActivatedDate</alias>
            <sourceFieldName>ActivatedDate</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>ActivatedDateTime</alias>
            <sourceFieldName>ActivatedDateTime</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>CopyOrderStatusValue</alias>
            <sourceFieldName>CopyOrderStatusValue</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>JournalDateTime</alias>
            <sourceFieldName>JournalDateTime</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>JournalSubTypeId</alias>
            <sourceFieldName>JournalSubTypeId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>JournalTypeId</alias>
            <sourceFieldName>JournalTypeId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>MemberId</alias>
            <sourceFieldName>MemberId</sourceFieldName>
            <sourceName>X6_FilterActiveLoyaltyProgramMembers</sourceName>
        </fields>
        <fields>
            <alias>MemberStatus</alias>
            <sourceFieldName>MemberStatus</sourceFieldName>
            <sourceName>X6_FilterActiveLoyaltyProgramMembers</sourceName>
        </fields>
        <fields>
            <alias>OrderId</alias>
            <sourceFieldName>OrderId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>OrderProductId</alias>
            <sourceFieldName>OrderProductId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>OrderStatus</alias>
            <sourceFieldName>OrderStatus</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>Product2Id</alias>
            <sourceFieldName>Product2Id</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>ProductCategoryId</alias>
            <sourceFieldName>ProductCategoryId</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>ProgramId</alias>
            <sourceFieldName>ProgramId</sourceFieldName>
            <sourceName>X6_FilterActiveLoyaltyProgramMembers</sourceName>
        </fields>
        <fields>
            <alias>Quantity</alias>
            <sourceFieldName>Quantity</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <fields>
            <alias>TotalPrice</alias>
            <sourceFieldName>TotalPrice</sourceFieldName>
            <sourceName>X10_FilterActiveOrder</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>AccountId</primarySourceFieldName>
            <secondarySourceFieldName>AccountId</secondarySourceFieldName>
        </joinKeys>
        <label>11.FilterActiveOrderPlusFilterActiveLoyaltyProgramMember</label>
        <name>X11_FilterActiveOrderPlusFilterActiveLoyaltyProgramMember</name>
        <primarySourceName>X10_FilterActiveOrder</primarySourceName>
        <secondarySourceName>X6_FilterActiveLoyaltyProgramMembers</secondarySourceName>
        <type>Inner</type>
    </joins>
    <joins>
        <fields>
            <alias>AccountId</alias>
            <sourceFieldName>AccountId</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>ActivatedDateTime</alias>
            <sourceFieldName>ActivatedDateTime</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>CopyOrderStatus</alias>
            <sourceFieldName>CopyOrderStatus</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>EffectiveDate</alias>
            <sourceFieldName>EffectiveDate</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>OrderId</alias>
            <sourceFieldName>Id</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>OrderProductId</alias>
            <sourceFieldName>OrderProductId</sourceFieldName>
            <sourceName>X2_OrderProduct</sourceName>
        </fields>
        <fields>
            <alias>OrderStatus</alias>
            <sourceFieldName>OrderStatus</sourceFieldName>
            <sourceName>X1_Order</sourceName>
        </fields>
        <fields>
            <alias>Product2Id</alias>
            <sourceFieldName>Product2Id</sourceFieldName>
            <sourceName>X2_OrderProduct</sourceName>
        </fields>
        <fields>
            <alias>Quantity</alias>
            <sourceFieldName>Quantity</sourceFieldName>
            <sourceName>X2_OrderProduct</sourceName>
        </fields>
        <fields>
            <alias>TotalPrice</alias>
            <sourceFieldName>TotalPrice</sourceFieldName>
            <sourceName>X2_OrderProduct</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>OrderId</primarySourceFieldName>
            <secondarySourceFieldName>Id</secondarySourceFieldName>
        </joinKeys>
        <label>5.OrderPlusOrderProduct</label>
        <name>X5_OrderPlusOrderProduct</name>
        <primarySourceName>X2_OrderProduct</primarySourceName>
        <secondarySourceName>X1_Order</secondarySourceName>
        <type>Inner</type>
    </joins>
    <joins>
        <fields>
            <alias>AccountId</alias>
            <sourceFieldName>AccountId</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>ActivatedDateTime</alias>
            <sourceFieldName>ActivatedDateTime</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>CopyOrderStatus</alias>
            <sourceFieldName>CopyOrderStatus</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>EffectiveDate</alias>
            <sourceFieldName>EffectiveDate</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>OrderId</alias>
            <sourceFieldName>OrderId</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>OrderProductId</alias>
            <sourceFieldName>OrderProductId</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>OrderStatus</alias>
            <sourceFieldName>OrderStatus</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>Product2Id</alias>
            <sourceFieldName>Product2Id</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>ProductCategoryId</alias>
            <sourceFieldName>ProductCategoryId</sourceFieldName>
            <sourceName>X7_FilterProductCategoryProduct</sourceName>
        </fields>
        <fields>
            <alias>Quantity</alias>
            <sourceFieldName>Quantity</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <fields>
            <alias>TotalPrice</alias>
            <sourceFieldName>TotalPrice</sourceFieldName>
            <sourceName>X5_OrderPlusOrderProduct</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>Product2Id</primarySourceFieldName>
            <secondarySourceFieldName>ProductId</secondarySourceFieldName>
        </joinKeys>
        <label>8.OrderPlusOrderProductPlusProductCategoryProduct</label>
        <name>X8_OrderPlusOrderProductPlusProductCategoryProduct</name>
        <primarySourceName>X5_OrderPlusOrderProduct</primarySourceName>
        <secondarySourceName>X7_FilterProductCategoryProduct</secondarySourceName>
        <type>LeftOuter</type>
    </joins>
    <label>Create Transaction Journals Based on Orders</label>
    <parameters>
        <dataType>Date</dataType>
        <isMultiValue>false</isMultiValue>
        <label>endDate</label>
        <name>endDate</name>
    </parameters>
    <parameters>
        <dataType>Text</dataType>
        <isMultiValue>false</isMultiValue>
        <label>journalSubTypeId</label>
        <name>journalSubTypeId</name>
    </parameters>
    <parameters>
        <dataType>Text</dataType>
        <isMultiValue>false</isMultiValue>
        <label>journalTypeId</label>
        <name>journalTypeId</name>
    </parameters>
    <parameters>
        <dataType>Text</dataType>
        <isMultiValue>false</isMultiValue>
        <label>programId</label>
        <name>programId</name>
    </parameters>
    <parameters>
        <dataType>Date</dataType>
        <isMultiValue>false</isMultiValue>
        <label>startDate</label>
        <name>startDate</name>
    </parameters>
    <processType>Loyalty</processType>
    <status>Active</status>
    <transforms>
        <expressionFields>
            <alias>CopyOrderStatus</alias>
            <dataType>Text</dataType>
            <expression>&quot;Processed&quot;</expression>
            <length>20</length>
        </expressionFields>
        <label>13.CopyOrderStaus</label>
        <name>X13_CopyOrderStaus</name>
        <sourceName>X12_OrdersToMarkAsPorcessed</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <transforms>
        <expressionFields>
            <alias>ActivatedDate</alias>
            <dataType>Date</dataType>
            <expression>DATEVALUE({ActivatedDateTime} )</expression>
        </expressionFields>
        <expressionFields>
            <alias>CopyOrderStatusValue</alias>
            <dataType>Text</dataType>
            <expression>&quot;Processed&quot;</expression>
            <length>20</length>
        </expressionFields>
        <expressionFields>
            <alias>JournalDateTime</alias>
            <dataType>DateTime</dataType>
            <expression>{ActivatedDateTime}</expression>
        </expressionFields>
        <expressionFields>
            <alias>JournalSubTypeId</alias>
            <dataType>Text</dataType>
            <expression>{$journalSubTypeId}</expression>
            <length>18</length>
        </expressionFields>
        <expressionFields>
            <alias>JournalTypeId</alias>
            <dataType>Text</dataType>
            <expression>{$journalTypeId}</expression>
            <length>18</length>
        </expressionFields>
        <label>9.FormulaActivatedDateJournalTypeJournalSubType</label>
        <name>X9_FormulaActivatedDateJournalTypeJournalSubType</name>
        <sourceName>X8_OrderPlusOrderProductPlusProductCategoryProduct</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <writebacks>
        <fields>
            <sourceFieldName>ActivatedDateTime</sourceFieldName>
            <targetFieldName>ActivityDate</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>MemberId</sourceFieldName>
            <targetFieldName>MemberId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>OrderId</sourceFieldName>
            <targetFieldName>OrderId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>OrderProductId</sourceFieldName>
            <targetFieldName>OrderItemId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>Product2Id</sourceFieldName>
            <targetFieldName>ProductId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>JournalTypeId</sourceFieldName>
            <targetFieldName>JournalTypeId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>JournalSubTypeId</sourceFieldName>
            <targetFieldName>JournalSubTypeId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>Quantity</sourceFieldName>
            <targetFieldName>Quantity</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>TotalPrice</sourceFieldName>
            <targetFieldName>TransactionAmount</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ProgramId</sourceFieldName>
            <targetFieldName>LoyaltyProgramId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ProductCategoryId</sourceFieldName>
            <targetFieldName>ProductCategoryId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>JournalDateTime</sourceFieldName>
            <targetFieldName>JournalDate</targetFieldName>
        </fields>
        <isChangedRow>false</isChangedRow>
        <label>14.CreateTransactionJournal</label>
        <name>X14_CreateTransactionJournal</name>
        <operationType>Insert</operationType>
        <sourceName>X11_FilterActiveOrderPlusFilterActiveLoyaltyProgramMember</sourceName>
        <storageType>sObject</storageType>
        <targetObjectName>TransactionJournal</targetObjectName>
        <writebackSequence>1</writebackSequence>
        <writebackUser>005Hr00000EirARIAZ</writebackUser>
    </writebacks>
    <writebacks>
        <fields>
            <sourceFieldName>OrderId</sourceFieldName>
            <targetFieldName>Id</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>CopyOrderStatus</sourceFieldName>
            <targetFieldName>CopyOrderStatus__c</targetFieldName>
        </fields>
        <isChangedRow>false</isChangedRow>
        <label>15. UpdateOrderProcessedStatus</label>
        <name>X15_UpdateOrderProcessedStatus</name>
        <operationType>Update</operationType>
        <sourceName>X13_CopyOrderStaus</sourceName>
        <storageType>sObject</storageType>
        <targetObjectName>Order</targetObjectName>
        <writebackSequence>2</writebackSequence>
        <writebackUser>005Hr00000EirARIAZ</writebackUser>
    </writebacks>
</BatchCalcJobDefinition>
