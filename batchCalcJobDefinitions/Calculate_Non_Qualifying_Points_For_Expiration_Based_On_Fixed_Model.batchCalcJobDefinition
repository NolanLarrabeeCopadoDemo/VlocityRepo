<?xml version="1.0" encoding="UTF-8"?>
<BatchCalcJobDefinition xmlns="http://soap.sforce.com/2006/04/metadata">
    <aggregates>
        <description>Aggregates the non-qualifying points to be considered for expiration. These points are grouped by member and currency.</description>
        <fields>
            <aggregateFunction>Sum</aggregateFunction>
            <alias>AggregatedLedgerPoints</alias>
            <sourceFieldName>Points</sourceFieldName>
        </fields>
        <fields>
            <aggregateFunction>Max</aggregateFunction>
            <alias>ExpirablePoints</alias>
            <sourceFieldName>ExpirablePoints</sourceFieldName>
        </fields>
        <fields>
            <aggregateFunction>Max</aggregateFunction>
            <alias>TotalPointsExpired</alias>
            <sourceFieldName>TotalPointsExpired</sourceFieldName>
        </fields>
        <fields>
            <aggregateFunction>Max</aggregateFunction>
            <alias>TotalPointsRedeemed</alias>
            <sourceFieldName>TotalPointsRedeemed</sourceFieldName>
        </fields>
        <groupBy>LoyaltyMemberCurrencyId</groupBy>
        <groupBy>LoyaltyProgramId</groupBy>
        <groupBy>LoyaltyProgramCurrencyId</groupBy>
        <groupBy>LoyaltyMemberId</groupBy>
        <label>Total Fixed Non-Qualifying Points To Expire</label>
        <name>TotalFixedNonQualifyingPointsToExpire</name>
        <sourceName>FilterPointsToExpire</sourceName>
    </aggregates>
    <datasources>
        <description>The loyalty ledger object is used as a data source for calculating non-qualifying points to expire.</description>
        <fields>
            <name>EventType</name>
        </fields>
        <fields>
            <name>ExpiryDate</name>
        </fields>
        <fields>
            <name>Id</name>
        </fields>
        <fields>
            <name>LoyaltyProgramCurrencyId</name>
        </fields>
        <fields>
            <name>LoyaltyProgramMemberId</name>
        </fields>
        <fields>
            <name>Points</name>
        </fields>
        <label>Loyalty Ledger</label>
        <name>LoyaltyLedger</name>
        <sourceName>LoyaltyLedger</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <description>The loyalty member currency is used as a data source for calculating non-qualifying points to expire.</description>
        <fields>
            <name>ExpirablePoints</name>
        </fields>
        <fields>
            <name>Id</name>
        </fields>
        <fields>
            <name>LastExpirationProcessRunDate</name>
        </fields>
        <fields>
            <name>LoyaltyMemberId</name>
        </fields>
        <fields>
            <name>LoyaltyProgramCurrencyId</name>
        </fields>
        <fields>
            <name>TotalPointsExpired</name>
        </fields>
        <fields>
            <name>Name</name>
        </fields>
        <fields>
            <name>PointsBalance</name>
        </fields>
        <fields>
            <name>TotalPointsRedeemed</name>
        </fields>
        <label>Loyalty Member Currency</label>
        <name>LoyaltyMemberCurrency</name>
        <sourceName>LoyaltyMemberCurrency</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <description>The loyalty program is used as a data source for calculating non-qualifying points to expire.</description>
        <fields>
            <name>Id</name>
        </fields>
        <fields>
            <name>Name</name>
        </fields>
        <label>Loyalty Program</label>
        <name>LoyaltyProgram</name>
        <sourceName>LoyaltyProgram</sourceName>
        <type>StandardObject</type>
    </datasources>
    <datasources>
        <description>The loyalty program currency is used as a data source for calculating non-qualifying points to expire.</description>
        <fields>
            <name>CurrencyType</name>
        </fields>
        <fields>
            <name>ExpiryModel</name>
        </fields>
        <fields>
            <name>Id</name>
        </fields>
        <fields>
            <name>LoyaltyProgramId</name>
        </fields>
        <label>Loyalty Program Currency</label>
        <name>LoyaltyProgramCurrency</name>
        <sourceName>LoyaltyProgramCurrency</sourceName>
        <type>StandardObject</type>
    </datasources>
    <description>Calculates and expires non-qualifying points for members based on the expiration date on the ledger.</description>
    <filters>
        <criteria>
            <inputVariable>LoyaltyProgramName</inputVariable>
            <operator>Equals</operator>
            <sequence>1</sequence>
            <sourceFieldName>LoyaltyProgramName</sourceFieldName>
        </criteria>
        <criteria>
            <operator>Equals</operator>
            <sequence>2</sequence>
            <sourceFieldName>CurrencyType</sourceFieldName>
            <value>NonQualifying</value>
        </criteria>
        <criteria>
            <operator>Equals</operator>
            <sequence>3</sequence>
            <sourceFieldName>ExpiryModel</sourceFieldName>
            <value>Fixed</value>
        </criteria>
        <criteria>
            <operator>Equals</operator>
            <sequence>4</sequence>
            <sourceFieldName>EventType</sourceFieldName>
            <value>Credit</value>
        </criteria>
        <description>Filters ledgers that have credited non-qualifying points to members with fixed expiry model.</description>
        <filterCondition>1 AND 2 AND 3 AND 4</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>Filter Fixed Non-Qualifying Points  Accrued</label>
        <name>FilterFixedNonQualifyingPointsAccrued</name>
        <sourceName>LPCAndLPPlusLL</sourceName>
    </filters>
    <filters>
        <criteria>
            <operator>Equals</operator>
            <sequence>1</sequence>
            <sourceFieldName>LedgerRecordsInValidDateRange</sourceFieldName>
            <value>Y</value>
        </criteria>
        <criteria>
            <inputVariable>ProcessRunDate</inputVariable>
            <operator>LessThanOrEquals</operator>
            <sequence>2</sequence>
            <sourceFieldName>ExpiryDate</sourceFieldName>
        </criteria>
        <description>Filters the ledgers to be considered for expiration.</description>
        <filterCondition>1 AND 2</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>Filter Points To Expire</label>
        <name>FilterPointsToExpire</name>
        <sourceName>LedgersWithPointsToExpire</sourceName>
    </filters>
    <filters>
        <criteria>
            <operator>GreaterThan</operator>
            <sequence>1</sequence>
            <sourceFieldName>ChangedExpiredPoints</sourceFieldName>
            <value>0</value>
        </criteria>
        <description>Filters members with non-zero points to expire.</description>
        <filterCondition>1</filterCondition>
        <isDynamicFilter>false</isDynamicFilter>
        <label>Total Points To Expire Greater Than Zero</label>
        <name>TotalPointsToExpiredGreaterThanZero</name>
        <sourceName>CurrentPointsToExpire</sourceName>
    </filters>
    <isTemplate>false</isTemplate>
    <joins>
        <description>Gets the current balance from Loyalty Member Currency records.</description>
        <fields>
            <alias>ExpirablePoints</alias>
            <sourceFieldName>ExpirablePoints</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <fields>
            <alias>ExpiryDate</alias>
            <sourceFieldName>ExpiryDate</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>LastExpirationProcessRunDate</alias>
            <sourceFieldName>LastExpirationProcessRunDate</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyLedgerId</alias>
            <sourceFieldName>LoyaltyLedgerId</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyMemberCurrencyId</alias>
            <sourceFieldName>Id</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyMemberId</alias>
            <sourceFieldName>LoyaltyMemberId</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramCurrencyId</alias>
            <sourceFieldName>LoyaltyProgramCurrencyId</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramId</alias>
            <sourceFieldName>LoyaltyProgramId</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>Points</alias>
            <sourceFieldName>Points</sourceFieldName>
            <sourceName>FilterFixedNonQualifyingPointsAccrued</sourceName>
        </fields>
        <fields>
            <alias>PointsBalance</alias>
            <sourceFieldName>PointsBalance</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <fields>
            <alias>TotalPointsExpired</alias>
            <sourceFieldName>TotalPointsExpired</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <fields>
            <alias>TotalPointsRedeemed</alias>
            <sourceFieldName>TotalPointsRedeemed</sourceFieldName>
            <sourceName>LoyaltyMemberCurrency</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>LoyaltyMemberId</primarySourceFieldName>
            <secondarySourceFieldName>LoyaltyMemberId</secondarySourceFieldName>
        </joinKeys>
        <joinKeys>
            <primarySourceFieldName>LoyaltyProgramCurrencyId</primarySourceFieldName>
            <secondarySourceFieldName>LoyaltyProgramCurrencyId</secondarySourceFieldName>
        </joinKeys>
        <label>Get Points for Ledger</label>
        <name>FilterFixedNonQualifyingPointsAccruedPlusLMC</name>
        <primarySourceName>FilterFixedNonQualifyingPointsAccrued</primarySourceName>
        <secondarySourceName>LoyaltyMemberCurrency</secondarySourceName>
        <type>LeftOuter</type>
    </joins>
    <joins>
        <description>Adds the loyalty program name, currency type, and expiration model to ledgers.</description>
        <fields>
            <alias>CurrencyType</alias>
            <sourceFieldName>CurrencyType</sourceFieldName>
            <sourceName>LPCPlusLP</sourceName>
        </fields>
        <fields>
            <alias>EventType</alias>
            <sourceFieldName>EventType</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <fields>
            <alias>ExpiryDate</alias>
            <sourceFieldName>ExpiryDate</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <fields>
            <alias>ExpiryModel</alias>
            <sourceFieldName>ExpiryModel</sourceFieldName>
            <sourceName>LPCPlusLP</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyLedgerId</alias>
            <sourceFieldName>Id</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyMemberId</alias>
            <sourceFieldName>LoyaltyProgramMemberId</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramCurrencyId</alias>
            <sourceFieldName>LoyaltyProgramCurrencyId</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramId</alias>
            <sourceFieldName>LoyaltyProgramId</sourceFieldName>
            <sourceName>LPCPlusLP</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramName</alias>
            <sourceFieldName>LoyaltyProgramName</sourceFieldName>
            <sourceName>LPCPlusLP</sourceName>
        </fields>
        <fields>
            <alias>Points</alias>
            <sourceFieldName>Points</sourceFieldName>
            <sourceName>LoyaltyLedger</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>LoyaltyProgramCurrencyId</primarySourceFieldName>
            <secondarySourceFieldName>LoyaltyProgramCurrencyId</secondarySourceFieldName>
        </joinKeys>
        <label>Add Loyalty Program Details to Ledger</label>
        <name>LPCAndLPPlusLL</name>
        <primarySourceName>LoyaltyLedger</primarySourceName>
        <secondarySourceName>LPCPlusLP</secondarySourceName>
        <type>LeftOuter</type>
    </joins>
    <joins>
        <description>Adds the loyalty program name to program currency records.</description>
        <fields>
            <alias>CurrencyType</alias>
            <sourceFieldName>CurrencyType</sourceFieldName>
            <sourceName>LoyaltyProgramCurrency</sourceName>
        </fields>
        <fields>
            <alias>ExpiryModel</alias>
            <sourceFieldName>ExpiryModel</sourceFieldName>
            <sourceName>LoyaltyProgramCurrency</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramCurrencyId</alias>
            <sourceFieldName>Id</sourceFieldName>
            <sourceName>LoyaltyProgramCurrency</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramId</alias>
            <sourceFieldName>Id</sourceFieldName>
            <sourceName>LoyaltyProgram</sourceName>
        </fields>
        <fields>
            <alias>LoyaltyProgramName</alias>
            <sourceFieldName>Name</sourceFieldName>
            <sourceName>LoyaltyProgram</sourceName>
        </fields>
        <joinKeys>
            <primarySourceFieldName>LoyaltyProgramId</primarySourceFieldName>
            <secondarySourceFieldName>Id</secondarySourceFieldName>
        </joinKeys>
        <label>Add Loyalty Program Name to Program Currency</label>
        <name>LPCPlusLP</name>
        <primarySourceName>LoyaltyProgramCurrency</primarySourceName>
        <secondarySourceName>LoyaltyProgram</secondarySourceName>
        <type>LeftOuter</type>
    </joins>
    <label>Calculate Non-Qualifying Points for Expiration Based on Fixed Model</label>
    <parameters>
        <dataType>Text</dataType>
        <description>The name of the loyalty program.</description>
        <isMultiValue>false</isMultiValue>
        <label>Loyalty Program Name</label>
        <name>LoyaltyProgramName</name>
    </parameters>
    <parameters>
        <dataType>Date</dataType>
        <description>The Process Run Date is used to update the LastExpirationProcessRunDate, and also to determine the unused points that are to be expired.</description>
        <isMultiValue>false</isMultiValue>
        <label>Process Run Date</label>
        <name>ProcessRunDate</name>
    </parameters>
    <processType>Loyalty</processType>
    <status>Active</status>
    <transforms>
        <description>Calculates the non-qualifying points, with a fixed expiry model, to be expired for the members since the last run.</description>
        <expressionFields>
            <alias>ChangedExpiredPoints</alias>
            <dataType>Numeric</dataType>
            <decimalPlaces>2</decimalPlaces>
            <expression>{NewExpiredPoints}-{TotalPointsExpired}</expression>
            <length>15</length>
        </expressionFields>
        <label>Current Points To Expire</label>
        <name>CurrentPointsToExpire</name>
        <sourceName>TotalExpiredPoints</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <transforms>
        <description>Identifies the ledgers to be considered for expiration.</description>
        <expressionFields>
            <alias>LedgerRecordsInValidDateRange</alias>
            <dataType>Text</dataType>
            <expression>(IF(ISNULL({LastExpirationProcessRunDate}), &quot;Y&quot;, IF(({ExpiryDate}&gt;{LastExpirationProcessRunDate}), &quot;Y&quot;, &quot;N&quot;)))</expression>
            <length>2</length>
        </expressionFields>
        <label>Ledgers With Points To Expire</label>
        <name>LedgersWithPointsToExpire</name>
        <sourceName>FilterFixedNonQualifyingPointsAccruedPlusLMC</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <transforms>
        <description>Calculates the total points that can be expired.</description>
        <expressionFields>
            <alias>NewExpirablePoints</alias>
            <dataType>Numeric</dataType>
            <decimalPlaces>2</decimalPlaces>
            <expression>({AggregatedLedgerPoints} + {ExpirablePoints})</expression>
            <length>15</length>
        </expressionFields>
        <label>Total Expirable Points</label>
        <name>TotalExpirablePoints</name>
        <sourceName>TotalFixedNonQualifyingPointsToExpire</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <transforms>
        <description>Calculates the total points that have expired.</description>
        <expressionFields>
            <alias>ActivityDate</alias>
            <dataType>DateTime</dataType>
            <expression>now()</expression>
        </expressionFields>
        <expressionFields>
            <alias>ActualProcessRunDate</alias>
            <dataType>Date</dataType>
            <expression>DATEVALUE({$ProcessRunDate})</expression>
        </expressionFields>
        <expressionFields>
            <alias>ExternalTransactionNumber</alias>
            <dataType>Text</dataType>
            <expression>UUID()</expression>
            <length>30</length>
        </expressionFields>
        <expressionFields>
            <alias>newEventType</alias>
            <dataType>Text</dataType>
            <expression>&quot;Expiry&quot;</expression>
            <length>10</length>
        </expressionFields>
        <expressionFields>
            <alias>NewExpiredPoints</alias>
            <dataType>Numeric</dataType>
            <decimalPlaces>2</decimalPlaces>
            <expression>(IF(({NewExpirablePoints} - {TotalPointsExpired}-{TotalPointsRedeemed}) &gt; 0, ({NewExpirablePoints}-{TotalPointsRedeemed}), {TotalPointsExpired}))</expression>
            <length>15</length>
        </expressionFields>
        <expressionFields>
            <alias>NqpExpiryJournalType</alias>
            <dataType>Text</dataType>
            <expression>&quot;Points Expiration&quot;</expression>
            <length>20</length>
        </expressionFields>
        <expressionFields>
            <alias>Status</alias>
            <dataType>Text</dataType>
            <expression>&quot;Processed&quot;</expression>
            <length>10</length>
        </expressionFields>
        <label>Total Expired Points</label>
        <name>TotalExpiredPoints</name>
        <sourceName>TotalExpirablePoints</sourceName>
        <transformationType>Expression</transformationType>
    </transforms>
    <writebacks>
        <description>Creates loyalty ledgers for expiring non-qualifying points.</description>
        <fields>
            <sourceFieldName>LoyaltyMemberId</sourceFieldName>
            <targetFieldName>LoyaltyProgramMemberId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>LoyaltyProgramCurrencyId</sourceFieldName>
            <targetFieldName>LoyaltyProgramCurrencyId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ActivityDate</sourceFieldName>
            <targetFieldName>ActivityDate</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ChangedExpiredPoints</sourceFieldName>
            <targetFieldName>Points</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>newEventType</sourceFieldName>
            <targetFieldName>EventType</targetFieldName>
        </fields>
        <fields>
            <parentName>TransactionJournal</parentName>
            <relationshipName>TransactionJournal</relationshipName>
            <sourceFieldName>ExternalTransactionNumber</sourceFieldName>
            <targetFieldName>ExternalTransactionNumber</targetFieldName>
        </fields>
        <isChangedRow>false</isChangedRow>
        <label>Create Loyalty Ledger</label>
        <name>CreateLoyaltyLedger</name>
        <operationType>Insert</operationType>
        <sourceName>TotalPointsToExpiredGreaterThanZero</sourceName>
        <storageType>sObject</storageType>
        <targetObjectName>LoyaltyLedger</targetObjectName>
        <writebackSequence>2</writebackSequence>
        <writebackUser>005Hr00000EirARIAZ</writebackUser>
    </writebacks>
    <writebacks>
        <description>Creates transaction journals for expiring non-qualifying points.</description>
        <fields>
            <sourceFieldName>ActivityDate</sourceFieldName>
            <targetFieldName>ActivityDate</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>LoyaltyMemberId</sourceFieldName>
            <targetFieldName>MemberId</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>LoyaltyProgramId</sourceFieldName>
            <targetFieldName>LoyaltyProgramId</targetFieldName>
        </fields>
        <fields>
            <parentName>JournalType</parentName>
            <relationshipName>JournalType</relationshipName>
            <sourceFieldName>NqpExpiryJournalType</sourceFieldName>
            <targetFieldName>Name</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>Status</sourceFieldName>
            <targetFieldName>Status</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ExternalTransactionNumber</sourceFieldName>
            <targetFieldName>ExternalTransactionNumber</targetFieldName>
        </fields>
        <isChangedRow>false</isChangedRow>
        <label>Create Transaction Journal</label>
        <name>CreateTransactionJournal</name>
        <operationType>Insert</operationType>
        <sourceName>TotalPointsToExpiredGreaterThanZero</sourceName>
        <storageType>sObject</storageType>
        <targetObjectName>TransactionJournal</targetObjectName>
        <writebackSequence>1</writebackSequence>
        <writebackUser>005Hr00000EirARIAZ</writebackUser>
    </writebacks>
    <writebacks>
        <description>Updates total expired points in the loyalty member currency records.</description>
        <fields>
            <sourceFieldName>LoyaltyMemberCurrencyId</sourceFieldName>
            <targetFieldName>Id</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>ActualProcessRunDate</sourceFieldName>
            <targetFieldName>LastExpirationProcessRunDate</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>NewExpiredPoints</sourceFieldName>
            <targetFieldName>TotalPointsExpired</targetFieldName>
        </fields>
        <fields>
            <sourceFieldName>NewExpirablePoints</sourceFieldName>
            <targetFieldName>ExpirablePoints</targetFieldName>
        </fields>
        <isChangedRow>false</isChangedRow>
        <label>Update Loyalty Member Currency</label>
        <name>UpdateLoyaltyMemberCurrency</name>
        <operationType>Update</operationType>
        <sourceName>TotalPointsToExpiredGreaterThanZero</sourceName>
        <storageType>sObject</storageType>
        <targetObjectName>LoyaltyMemberCurrency</targetObjectName>
        <writebackSequence>3</writebackSequence>
        <writebackUser>005Hr00000EirARIAZ</writebackUser>
    </writebacks>
</BatchCalcJobDefinition>
